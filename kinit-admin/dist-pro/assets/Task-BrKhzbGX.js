var Z=Object.defineProperty;var D=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var B=(n,s,l)=>s in n?Z(n,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[s]=l,F=(n,s)=>{for(var l in s||(s={}))ee.call(s,l)&&B(n,l,s[l]);if(D)for(var l of D(s))te.call(s,l)&&B(n,l,s[l]);return n};var v=(n,s,l)=>new Promise((x,w)=>{var C=u=>{try{g(l.next(u))}catch(_){w(_)}},T=u=>{try{g(l.throw(u))}catch(_){w(_)}},g=u=>u.done?x(u.value):Promise.resolve(u.value).then(C,T);g((l=l.apply(n,s)).next())});import{a as ae,r as le,b as oe,d as se,c as ie,p as re}from"./task-Ccqc7o_P.js";import{u as ne,_ as ue}from"./Table.vue_vue_type_script_lang-C8htGDV6.js";import{d as pe,v as p}from"./index-SAHUQZ2g.js";/* empty css                  *//* empty css               *//* empty css                       *//* empty css                 *//* empty css                   */import{_ as de}from"./Search.vue_vue_type_script_setup_true_lang-DSCbi6Eq.js";import{_ as me}from"./ContentWrap.vue_vue_type_script_setup_true_lang-Bq-Mkqar.js";import{_ as ce}from"./Write.vue_vue_type_script_setup_true_lang-DwEH09PV.js";import{_ as fe}from"./Dialog.vue_vue_type_style_index_0_lang-Bhm9ynpg.js";import{f as ve,ao as _e,Q as M,M as o,F as A,K as d,a as m,h as E,i as we,G as r,u as t,q as j,L as I,E as N,J as O}from"./vue-chunks-wbK7PffK.js";import{_ as ge}from"./CronExpression.vue_vue_type_style_index_0_lang-DfbncZED.js";import{V as ye,w as ke,b as U,p as be,j as S}from"./element-plus-C0vem28W.js";/* empty css                        *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css               *//* empty css                      *//* empty css                  *//* empty css                        *//* empty css                */import"./useForm-B5RQKQQi.js";/* empty css                     *//* empty css                 *//* empty css                          *//* empty css                       *//* empty css                       *//* empty css                   *//* empty css                *//* empty css                    */import"./style.css_vue_type_style_index_0_src_true_lang-BFkgkg1x.js";import"./wang-editor-K_dPeC8b.js";/* empty css                   *//* empty css                    *//* empty css                         */import"./_Uint8Array-DZlgfqcV.js";import"./useIcon-DF_xcSd1.js";import"./useValidator-UROf_CnT.js";import"./dict-D8O779xT.js";import"./dict-D1Ddn9_W.js";/* empty css                  */import"./RunDatetimeList-BLbntbCo.js";import"./CronExample-Cyy6aFXN.js";const vt=ve({name:"SystemTask",__name:"Task",setup(n){const{push:s}=_e(),{t:l}=pe(),{tableRegister:x,tableState:w,tableMethods:C}=ne({fetchDataApi:()=>v(this,null,function*(){const{pageSize:a,currentPage:e}=w,i=yield oe(F({page:t(e),limit:t(a)},t(L)));return{list:i.data||[],total:i.count||0}}),fetchDelApi:a=>v(this,null,function*(){return(yield se(a)).code===200})}),{dataList:T,loading:g,total:u,pageSize:_,currentPage:y}=w,{getList:k,delList:q}=C,G=M([{field:"_id",label:"任务编号",show:!0,disabled:!0,width:"230px",span:24},{field:"name",label:"任务名称",show:!0,disabled:!0,span:24},{field:"group",label:"任务分组",show:!0,span:24},{field:"job_class",label:"调用目标",show:!0,span:24},{field:"exec_strategy",label:"执行策略",show:!0,colProps:{span:24},componentProps:{style:{width:"100%"}}},{field:"expression",label:"表达式",show:!0,span:24},{field:"is_active",label:"任务状态",show:!0,width:"100px",slots:{default:a=>{const e=a.row;return o(A,null,[o(ye,{modelValue:e.is_active,disabled:!0},null)])}}},{field:"last_run_datetime",label:"最近一次执行时间",show:!0,width:"180px",span:24},{field:"remark",label:"任务备注",show:!0,span:24},{field:"create_datetime",label:"创建时间",show:!0,width:"180px",span:24},{field:"action",label:"操作",show:!0,disabled:!1,width:"240px",slots:{default:a=>{const e=a.row;return o(A,null,[o(p,{type:"primary",link:!0,size:"small",onClick:()=>Q(e)},{default:()=>[d("编辑")]}),o(p,{type:"primary",link:!0,size:"small",onClick:()=>V(e)},{default:()=>[d("调度日志")]}),o(p,{type:"primary",link:!0,size:"small",onClick:()=>Y(e)},{default:()=>[d("执行一次")]}),o(p,{type:"danger",link:!0,size:"small",onClick:()=>K(e)},{default:()=>[d("删除")]})])}}}]),J=M([{field:"name",label:"任务名称",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"_id",label:"任务编号",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"group",label:"任务分组",component:"Select",componentProps:{style:{width:"214px"},options:[]}}]),L=m({}),P=a=>{y.value=1,L.value=a,k()},$=m(!1),K=a=>v(this,null,function*(){$.value=!0,yield q(!0,[a._id]).finally(()=>{$.value=!1})}),c=m(!1),b=m(""),h=m(),f=m(""),z=m(),R=m(!1),Q=a=>v(this,null,function*(){const e=yield ae(a._id);e&&(b.value="编辑定时任务",f.value="edit",h.value=e.data,c.value=!0)}),H=()=>{b.value="新增定时任务",f.value="add",h.value=void 0,c.value=!0},W=()=>v(this,null,function*(){const a=t(z),e=yield a==null?void 0:a.submit();if(e){R.value=!0;try{const i=m({});f.value==="add"?(i.value=yield ie(e),i.value&&(c.value=!1,k())):f.value==="edit"&&(i.value=yield re(e._id,e),i.value&&(c.value=!1,k()))}finally{R.value=!1}}}),X=()=>{b.value="Cron 表达式",f.value="expression",h.value=void 0,c.value=!0},V=a=>{s(a?`/record/task?job_id=${a._id}`:"/record/task")},Y=a=>v(this,null,function*(){ke.confirm("是否确认立即执行一次任务","提示",{confirmButtonText:l("common.delOk"),cancelButtonText:l("common.delCancel"),type:"warning"}).then(()=>v(this,null,function*(){const e=yield le(a._id);e&&(e.data>0?U.success("任务成功被消费者接收！"):U.error("执行失败，未有消费者接收任务，请检查定时任务程序状态！"))}))});return(a,e)=>(E(),we(A,null,[o(t(me),null,{default:r(()=>[o(t(de),{schema:J,onReset:P,onSearch:P},null,8,["schema"]),o(t(ue),{"current-page":t(y),"onUpdate:currentPage":e[1]||(e[1]=i=>j(y)?y.value=i:null),"page-size":t(_),"onUpdate:pageSize":e[2]||(e[2]=i=>j(_)?_.value=i:null),showAction:"",columns:G,"default-expand-all":"","node-key":"id",data:t(T),loading:t(g),pagination:{total:t(u)},onRegister:t(x),onRefresh:t(k)},{toolbar:r(()=>[o(t(be),{gutter:10},{default:r(()=>[o(t(S),{span:1.5},{default:r(()=>[o(t(p),{type:"primary",onClick:H},{default:r(()=>[d("新增定时任务")]),_:1})]),_:1}),o(t(S),{span:1.5},{default:r(()=>[o(t(p),{type:"primary",onClick:e[0]||(e[0]=i=>V(null))},{default:r(()=>[d("调度日志")]),_:1})]),_:1}),o(t(S),{span:1.5},{default:r(()=>[o(t(p),{type:"primary",onClick:X},{default:r(()=>[d("快速生成 Cron 表达式")]),_:1})]),_:1})]),_:1})]),_:1},8,["current-page","page-size","columns","data","loading","pagination","onRegister","onRefresh"])]),_:1}),o(t(fe),{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=i=>c.value=i),title:b.value,height:680,width:850},{footer:r(()=>[o(t(p),{type:"primary",loading:R.value,onClick:W},{default:r(()=>[d(I(t(l)("exampleDemo.save")),1)]),_:1},8,["loading"]),o(t(p),{onClick:e[3]||(e[3]=i=>c.value=!1)},{default:r(()=>[d(I(t(l)("dialogDemo.close")),1)]),_:1})]),default:r(()=>[f.value==="add"||f.value==="edit"?(E(),N(ce,{key:0,ref_key:"writeRef",ref:z,"current-row":h.value},null,8,["current-row"])):O("",!0),f.value==="expression"?(E(),N(ge,{key:1})):O("",!0)]),_:1},8,["modelValue","title"])],64))}});export{vt as default};
